import os
import requests
from flask import Flask, render_template, request, jsonify

app = Flask(__name__)

# --- SECURE KEYS (Set these in Render) ---
GOOGLE_API_KEY = os.environ.get('GOOGLE_API_KEY')
FEC_API_KEY = os.environ.get('FEC_API_KEY')

# --- 1. THE HUMANITY SCORE (SOVEREIGNTY AUDIT) ---
def get_trust_rating(name, candidate_id):
    """Calculates an objective score based on Autonomy vs. Centralization."""
    score = 100
    # Penalty keywords for Globalist/Project Z alignment
    red_flags = ['BlackRock', 'Vanguard', 'WHO', 'Genomic', 'Consortium', 'Swiss Vault']
    
    # Placeholder for FEC donor check logic
    # In a live app, this would iterate through contributor_name in FEC API results
    has_globalist_funding = False # Logic: If match in red_flags, deduct 25
    
    return score - 25 if has_globalist_funding else score

# --- 2. FORENSIC JUDICIAL AUDIT ---
def audit_record(name, office):
    """Checks for patterns of 'Backbone' vs. 'Weakness'."""
    if "Judge" in office:
        return f"https://www.courtlistener.com/?q={name.replace(' ', '+')}" # Judicial Evidence
    return f"https://archive.org/search.php?query={name.replace(' ', '+')}+hearings" # Political Evidence

# --- 3. GIFTGRAM BILLING MODULE ---
@app.route('/giftgram/calculate', methods=['POST'])
def giftgram_logic():
    data = request.json
    amount = float(data.get('amount', 0))
    friends = int(data.get('friends', 1))
    
    fee = amount * 0.02  # Your specific 2% fee
    total = amount + fee
    return jsonify({"per_person": round(total/friends, 2), "fee": round(fee, 2)})

# --- 4. UNIVERSAL SEARCH HUB ---
@app.route('/', methods=['GET', 'POST'])
def home():
    results = []
    if request.method == 'POST':
        address = request.form.get('address')
        # Google Civic API: Works for ALL 50 States & Districts
        url = f"https://www.googleapis.com/civicinfo/v2/representatives?address={address}&key={GOOGLE_API_KEY}"
        data = requests.get(url).json()
        
        for office in data.get('offices', []):
            for idx in office.get('officialIndices', []):
                official = data['officials'][idx]
                name = official.get('name')
                
                results.append({
                    "name": name,
                    "office": office.get('name'),
                    "photo": official.get('photoUrl', 'https://via.placeholder.com/150'),
                    "score": get_trust_rating(name, ""),
                    "evidence": audit_record(name, office.get('name'))
                })
    return render_template('index.html', candidates=results)

if __name__ == "__main__":
    app.run(debug=True)
